# 仕様

参考: [情報処理技術者試験 試験で仕様する情報技術に関する用語・プログラム言語など](https://www.jitec.ipa.go.jp/1_13download/shiken_yougo_ver4_3.pdf) 別紙2

- : 実装済みの基本仕様
- [x] : 実装済みの拡張仕様
- [ ] : 未実装の基本/拡張仕様

## アセンブラ (extended-CaslII)

`casl2 -s path/to/src -o path/to/dist [-d]`

-s/--src : ソースファイルを指定

- [ ] 複数ファイルを指定可能

-o/--out : 出力先ファイルを指定

-d : デバッグ用

- [ ] ユーザ用にデバッグ機能を整える

### 基本仕様

CaslIIの文法を比較的寛容にしたものをベースに拡張する

- 先頭以外のスペースは無視する。
  - コンマの前後等スペースも問題がない
- 命令名,レジスタ名は大文字と小文字を区別しない。
  - `ADDL`,`Addl`,`addl`,`AddL` は同じ扱い
- ラベル名は大文字と小文字を区別する。
  - `LABEL`,`Label`,`label` はそれぞれ別のラベル名

- [ ] ELF形式で出力
  - [ ] 最終的にスタティックリンクした実行可能ELFを出力
  - [ ] オブジェクトファイルを出力可能
  - [ ] ダイナミックリンクした実行可能ELFを出力可能
  - 現状は命令のバイナリを並べただけのファイルを出力している

### 変更した仕様

- [ ] `START`-`END` を1ファイルに複数配置できる。
  - `START`-`END` の入れ子はできない
  - `START`-`END` 外にマクロ以外は書けない
  -  間は空にできない (ラベルが空振るので)
- [ ] `.`から始まるラベル名はローカルラベルになる
  - スコープはその `START`-`END` の内
  - `STARTのラベル.ローカルラベル` に展開する.
- [x] CometII-core の拡張命令を使用できる
- [ ] 16進数を `0x` で書ける
- [ ] 2進数を `0b` で書ける

### マクロ

実装しならが仕様が変わりそう

- [ ] マクロ定義
  - [ ] 引数の展開
  - [ ] マクロ内変数の実装
  - [ ] マクロの可変長引数
    - `...$args` で定義 / `$args[i]` でアクセス / `$args.len` で長さ
  - [ ] 繰り返しの実装
イメージ:

```
MACRO_NAME MACRO $arg1, $arg2, $hoge, ...
    push 0, $arg1
    push 0, $arg2
    pop $hoge
    MACROEND
```

```
マクロ名 MACRO { $引数名 { , $引数名 {...} } }
    命令
    ...
    MACROEND
```

- [ ] インライン定数定義
  - `const_name is const_value`

## マシン (CometII-core)

実装中に仕様は変わるので参考程度 (メモ)

参考: [COMET-II互換プロセッサによるCPU設計演習環境の開発](https://www.ieice.org/publications/conference-FIT-DVDs/FIT2002/pdf/C/C_1.PDF)

### シミュレータ

`comet2 [-r path/to/root] [-d path/to/dispfile]`

-r/--root-path : マシンのストレージとして使うディレクトリ

- [x] ルートディレクトリの `/kernel.bin` を実行する
  - [ ] ELF の実行に対応
  - [ ] そのうち仮想ハードディスクとかにする

-d/--display-file : ディスプレイとして使うファイル

- [x] メモリの `0x2010 - 0x21ff` をフレームバッファとして文字を表示 (20*20文字)
  - フレームバッファは1バイトごとに文字コードとして解釈する.

- [ ] -i/--display-image
  - [ ] フレームバッファをドットの並びとして解釈する
- [ ] -c/--color
  - [ ] フレームバッファをドット(RGB)の並びとして解釈する
- [ ] -w/--display-width, -h/--display-height
  - [ ] 幅と高さを設定できる

### マシン

#### 基本仕様

- 1 word == 2 byte (2 octet) == 16 bit
- メモリは 0x10000 word,アドレス0-0xffff,1 wordごとにアドレスを振る
- GR0-7 : 1 word,自由に利用できる
- SP : 1 word,スタックポインタ
- PR : 1 word,次の命令のアドレスを保持する
- FR : OF,SF,ZF を保持する (追加するフラグは拡張仕様に書く)
  - OF : オーバーフロー
  - SF : サイン
  - ZF : ゼロ

#### 拡張仕様

- FR
  - [ ] PL : 特権レベル (0: マシン, 1: ユーザ)
  - [x] IE : 割り込み許可 (0: 禁止, 1: 許可)
- [x] IM : 1 word, 割り込み要因マスクを保持する
- メモリマップ
  - [x] 0x0000 : カーネルプログラムを読み込む
  - [x] 0x2000-0x200f : 割り込みベクタ
  - [x] 0x2010-0x21ff : フレームバッファ

- 割り込み要因
  - 1: 不正な命令
  - 2: 一般保護
  - 3: BIOSコール
  - 4: タイマー

  - 8-15: ユーザ定義

割り込み時、GR0, FR, PR をスタックに積み、割り込み禁止にする

// TODO: 他のプロセッサのISAを調べる.
- [ ] システムコール (SVC adr [, x])
  - GR/FR が不定になる (基本仕様)
  - 実行アドレスをシステムコール番号とする
  - なんらか固定アドレスを起点としてハンドラを呼び出す (割り込みと同じ)
    - or システムコールアドレスレジスタを使う

// TODO: 他のプロセッサの機構を調べる
- [ ] 割り込み/システムコール時の特権昇格

### 命令

基本は特権命令 (INT,SVC は非特権命令)

- [x] EI : 割り込み許可
- [x] DI : 割り込み禁止
- [ ] LDM r : マスク読み込み
- [ ] STM r : マスク書き込み
- [ ] LSP r : SP読み込み
- [ ] SSP r : SP書き込み
- [x] INT : 割り込み
- [ ] SVC : システムコール
- [ ] IRET : 割り込みハンドラからのリターン
